# Настройка конвертации PDF в JSON

Проект теперь использует алгоритм конвертации PDF выписок в JSON из `/Users/mshaimard/pdf` перед отправкой данных агенту.

## Как это работает

1. Пользователь загружает PDF выписки через веб-интерфейс
2. PDF файлы автоматически конвертируются в JSON через Python-сервис
3. JSON содержит только операции по КРЕДИТУ (поступления на счет)
4. JSON отправляется агенту для анализа
5. Агент анализирует операции по полю "Назначение платежа" и определяет, является ли каждая операция выручкой

## Настройка

### Вариант 1: Использование Python скрипта напрямую (по умолчанию)

1. Убедитесь, что Python 3 установлен и доступен как `python3`
2. Установите зависимости Python-сервиса:
   ```bash
   cd /Users/mshaimard/pdf
   pip install -r requirements.txt
   ```
3. Настройте переменные окружения для Adobe API (обязательно):
   ```bash
   export ADOBE_CLIENT_ID=ваш_client_id
   export ADOBE_CLIENT_SECRET=ваш_client_secret
   # или
   export ADOBE_CREDENTIALS_FILE=/path/to/pdfservices-api-credentials.json
   ```
4. Опционально настройте путь к Python:
   ```bash
   export PYTHON_PATH=python3  # или python, или полный путь
   ```

### Вариант 2: Использование HTTP сервиса

1. Запустите Python-сервис как отдельный сервер:
   ```bash
   cd /Users/mshaimard/pdf
   uvicorn app.main:app --host 0.0.0.0 --port 8000
   ```
2. Настройте переменные окружения:
   ```bash
   export USE_PDF_SERVICE_HTTP=true
   export PDF_SERVICE_URL=http://localhost:8000
   export PDF_SERVICE_PORT=8000
   ```

## Переменные окружения

- `PDF_SERVICE_PATH` - путь к директории с Python-сервисом (по умолчанию: `/Users/mshaimard/pdf`)
- `PYTHON_PATH` - путь к исполняемому файлу Python (по умолчанию: `python3`)
- `USE_PDF_SERVICE_HTTP` - использовать HTTP запросы вместо прямого вызова Python (по умолчанию: `false`)
- `PDF_SERVICE_URL` - URL Python-сервиса при использовании HTTP (по умолчанию: `http://localhost:8000`)
- `PDF_SERVICE_PORT` - порт Python-сервиса (по умолчанию: `8000`)

## Формат JSON данных

После конвертации создается JSON файл со следующей структурой:

```json
{
  "metadata": [
    {
      "source_file": "statement1.pdf",
      "bank_name": "Банк",
      "bin_iin": "123456789012",
      "period_from": "01.01.2024",
      "period_to": "31.12.2024"
    }
  ],
  "transactions": [
    {
      "Дата": "15.01.2024",
      "Кредит": "100000,00",
      "Назначение платежа": "Оплата за товары",
      "№": "12345",
      "Отправитель": "ООО Клиент",
      "Получатель": "ООО Компания"
    }
  ],
  "summary": {
    "total_files": 1,
    "total_transactions": 10,
    "converted_at": "2024-01-15T10:30:00.000Z"
  }
}
```

## Что изменилось

1. **Инструкции для агента упрощены** - теперь агент получает уже очищенные данные и должен только определить, является ли операция выручкой по назначению платежа
2. **PDF файлы автоматически конвертируются** - пользователь загружает PDF, система конвертирует их в JSON
3. **Агент получает JSON вместо PDF** - это ускоряет анализ и делает его более точным

## Устранение неполадок

### Ошибка: "Python скрипт завершился с ошибкой"
- Проверьте, что Python установлен и доступен
- Проверьте, что все зависимости установлены (`pip install -r requirements.txt`)
- Проверьте, что Adobe API credentials настроены правильно

### Ошибка: "Не удалось конвертировать PDF через HTTP"
- Убедитесь, что Python-сервис запущен (`uvicorn app.main:app`)
- Проверьте, что `PDF_SERVICE_URL` указан правильно
- Проверьте логи Python-сервиса

### Нет транзакций в результате
- Это нормально, если в PDF нет операций по кредиту
- Агент получит JSON с пустым массивом транзакций и сообщит об этом в отчете

